
{% extends 'base.html' %}
{% block head %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBj1g_2Ag8L5rTustAap0vqn7D_H14rewo&libraries=places"></script>

    <script>
      function writeAddressName(latLng) {
        var geocoder = new google.maps.Geocoder();
        geocoder.geocode({
          "location": latLng
        },
        function(results, status) {
          if (status == google.maps.GeocoderStatus.OK)
            document.getElementById("address").innerHTML = results[0].formatted_address;
          else
            document.getElementById("error").innerHTML += "Unable to retrieve your address" + "<br />";
        });
      }

      function geolocationSuccess(position) {
        var userLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        // Write the formatted address
        writeAddressName(userLatLng);

        var myOptions = {
          zoom : 15,
          center : userLatLng,
          mapTypeId : google.maps.MapTypeId.ROADMAP
        };

        // Draw the map
        var mapObject = new google.maps.Map(document.getElementById("googleMap"), myOptions);
        var infowindow = new google.maps.InfoWindow();
        var service = new google.maps.places.PlacesService(mapObject);
        
        // var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';

        new google.maps.Marker({
            map: mapObject,
           position: userLatLng,
           icon: 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png'
         });


        service.nearbySearch({
        	location: userLatLng,
        	radius: 2500,
        	keyword: ['dispensary']
        }, callback);

      //   def function initMap(place) {
      //   var directionsService = new google.maps.DirectionsService;
      //   var directionsDisplay = new google.maps.DirectionsRenderer;
      //   var map = new google.maps.Map(document.getElementById('googleMap'), {
      //     zoom: 7,
      //     center: {userLatLng}
      //   });
      //   directionsDisplay.setMap(googleMap);

      //   var onChangeHandler = function() {
      //     calculateAndDisplayRoute(directionsService, directionsDisplay);
      //   };
      //   document.getElementById('userLatLng').addEventListener('change', onChangeHandler);
      //   document.getElementById('place.geometry.location').addEventListener('change', onChangeHandler);
      // }

      // function calculateAndDisplayRoute(directionsService, directionsDisplay) {
      //   directionsService.route({
      //     origin: document.getElementById('userLatLng').value,
      //     destination: document.getElementById('place.geometry.location').value,
      //     travelMode: 'TRANSIT'
      //   }, function(response, status) {
      //     if (status === 'OK') {
      //       directionsDisplay.setDirections(response);
      //     } else {
      //       window.alert('Directions request failed due to ' + status);
      //     }
      //   });
      // }


// def function directions(client, origin=userLatLng, destination=place.geometry.location,
//                mode=transit, waypoints=None, alternatives=True, avoid=None,
//                language=None, units=None, region=None, departure_time=datetime.datetime,
//                arrival_time=None, optimize_waypoints=False, transit_mode=None,
//                transit_routing_preference=None, traffic_model=None);

      function callback(results, status) {
        debugger
        if (status === google.maps.places.PlacesServiceStatus.OK) {
        	console.log('results', results)
          for (var i = 0; i < results.length; i++) {
            createMarker(results[i]);
          }
        }
      }

      function createMarker(place) {
      	console.log('place', place.geometry.location)
        var placeLoc = place.geometry.location;
        var marker = new google.maps.Marker({
            map: mapObject,
            position: place.geometry.location
         });

        google.maps.event.addListener(marker, 'click', function() {
          infowindow.setContent(place.name + "<br>" + place.formatted_address +"<br>" + place.website + "<br>" + place.rating + "<br>" + place.formatted_phone_number + "<br>" + );
          infowindow.open(googleMap, this);
        });
      }

      // <a href = function initMap() "Get Directions"</a>

      }

      function geolocationError(positionError) {
        document.getElementById("error").innerHTML += "Error: " + positionError.message + "<br />";
      }

      function geolocateUser() {
        // If the browser supports the Geolocation API
        if (navigator.geolocation)
        {
          var positionOptions = {
            enableHighAccuracy: true,
            timeout: 10 * 1000 // 10 seconds
          };
          navigator.geolocation.getCurrentPosition(geolocationSuccess, geolocationError, positionOptions);
        }
        else
          document.getElementById("error").innerHTML += "Your browser doesn't support the Geolocation API";
      }


      window.onload = geolocateUser();
    </script>
    
  {% endblock %}

{% block content %}
  <h2>Welcome, {{ user.username }}!</h2>


  <div id="googleMap" style="width:100%;height:600px;"></div>

    <p><b>Address</b>: <span id="address"></span></p>
    <p id="error"></p>




   




{% endblock %}